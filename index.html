<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å°ˆæ¡ˆè¡Œäº‹æ›† - ä»»å‹™é¡¯ç¤ºç®¡ç†</title>
    <link rel="stylesheet" href="css/calendar.css?v=2">
    <!-- æ¸…é™¤ JavaScript æ–‡ä»¶å¿«å–çš„å…§è¯è…³æœ¬ -->
    <script>
        (function() {
            // æª¢æŸ¥ URL åƒæ•¸ä¸­æ˜¯å¦æœ‰ _nocache
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('_nocache')) {
                const timestamp = urlParams.get('_nocache');
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†éï¼ˆä½¿ç”¨ sessionStorage é¿å…ç„¡é™å¾ªç’°ï¼‰
                const processedKey = '_cache_cleared_' + timestamp;
                if (sessionStorage.getItem(processedKey)) {
                    // å·²ç¶“è™•ç†éï¼Œç§»é™¤ URL åƒæ•¸å’Œæ¨™è¨˜
                    urlParams.delete('_nocache');
                    const cleanUrl = window.location.pathname + 
                        (urlParams.toString() ? '?' + urlParams.toString() : '') + 
                        (window.location.hash || '');
                    window.history.replaceState({}, '', cleanUrl);
                    sessionStorage.removeItem(processedKey);
                    return;
                }
                
                // æ¨™è¨˜ç‚ºå·²è™•ç†
                sessionStorage.setItem(processedKey, 'true');
                
                // ç«‹å³ç§»é™¤ URL åƒæ•¸
                urlParams.delete('_nocache');
                const cleanUrl = window.location.pathname + 
                    (urlParams.toString() ? '?' + urlParams.toString() : '') + 
                    (window.location.hash || '');
                window.history.replaceState({}, '', cleanUrl);
                
                // æ›´æ–°æ‰€æœ‰ script æ¨™ç±¤çš„ç‰ˆæœ¬è™Ÿ
                function updateScriptVersions() {
                    console.log('é–‹å§‹æ›´æ–° script ç‰ˆæœ¬è™Ÿï¼Œç›®æ¨™æ™‚é–“æˆ³:', timestamp);
                    const scripts = document.querySelectorAll('script[src]');
                    let updated = false;
                    let processedCount = 0;
                    
                    scripts.forEach(function(script) {
                        const src = script.getAttribute('src');
                        if (src && !src.includes('cdnjs.cloudflare.com')) {
                            // åªæ›´æ–°æœ¬åœ°æ–‡ä»¶ï¼Œä¸æ›´æ–° CDN æ–‡ä»¶
                            processedCount++;
                            try {
                                const url = new URL(src, window.location.origin);
                                const currentVersion = url.searchParams.get('v');
                                console.log('æª¢æŸ¥ script:', src.substring(0, 40), 'ç•¶å‰ç‰ˆæœ¬:', currentVersion, 'ç›®æ¨™ç‰ˆæœ¬:', timestamp);
                                // å¦‚æœç‰ˆæœ¬è™Ÿä¸åŒï¼Œæ›´æ–°å®ƒ
                                if (currentVersion !== timestamp) {
                                    url.searchParams.set('v', timestamp);
                                    script.src = url.pathname + '?' + url.searchParams.toString();
                                    updated = true;
                                    console.log('âœ“ å·²æ›´æ–° script ç‰ˆæœ¬è™Ÿ:', script.src);
                                } else {
                                    console.log('  script ç‰ˆæœ¬è™Ÿå·²æ˜¯æœ€æ–°ï¼Œè·³é');
                                }
                            } catch (e) {
                                // å¦‚æœ URL è§£æå¤±æ•—ï¼Œå˜—è©¦ç°¡å–®çš„å­—ä¸²æ›¿æ›
                                console.log('URL è§£æå¤±æ•—ï¼Œä½¿ç”¨å­—ä¸²æ›¿æ›:', src.substring(0, 40));
                                if (!src.includes('v=' + timestamp)) {
                                    const separator = src.includes('?') ? '&' : '?';
                                    const newSrc = src.replace(/[?&]v=\d+/, '') + separator + 'v=' + timestamp;
                                    script.src = newSrc;
                                    updated = true;
                                    console.log('âœ“ å·²æ›´æ–° script ç‰ˆæœ¬è™Ÿ (å­—ä¸²æ›¿æ›):', script.src);
                                } else {
                                    console.log('  script ç‰ˆæœ¬è™Ÿå·²æ˜¯æœ€æ–°ï¼ˆå­—ä¸²æª¢æŸ¥ï¼‰ï¼Œè·³é');
                                }
                            }
                        }
                    });
                    
                    console.log('ç‰ˆæœ¬è™Ÿæ›´æ–°å®Œæˆï¼Œè™•ç†äº†', processedCount, 'å€‹ scriptï¼Œæ›´æ–°äº†', updated ? 'æ˜¯' : 'å¦');
                    
                    // æ¸…é™¤ Cache API å¿«å–ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    if ('caches' in window) {
                        caches.keys().then(function(names) {
                            return Promise.all(names.map(function(name) {
                                console.log('æ¸…é™¤å¿«å–:', name);
                                return caches.delete(name);
                            }));
                        }).then(function() {
                            console.log('å·²æ¸…é™¤æ‰€æœ‰ Cache API å¿«å–');
                        });
                    }
                    
                    if (updated) {
                        console.log('å·²æ›´æ–°æ‰€æœ‰ JavaScript æ–‡ä»¶ï¼ˆåŒ…æ‹¬ config.jsï¼‰ç‰ˆæœ¬è™Ÿï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥æ¸…é™¤å¿«å–...');
                        // å¼·åˆ¶é‡æ–°è¼‰å…¥ï¼ˆä¸ä½¿ç”¨å¿«å–ï¼‰
                        // å…ˆæ¸…é™¤æ‰€æœ‰å¿«å–ï¼Œç„¶å¾Œé‡æ–°è¼‰å…¥
                        if ('caches' in window) {
                            caches.keys().then(function(names) {
                                return Promise.all(names.map(function(name) {
                                    return caches.delete(name);
                                }));
                            }).then(function() {
                                console.log('å·²æ¸…é™¤æ‰€æœ‰ Cache API å¿«å–ï¼Œæº–å‚™é‡æ–°è¼‰å…¥...');
                                // ä½¿ç”¨ replace ç¢ºä¿ä¸ä½¿ç”¨å¿«å–
                                window.location.replace(window.location.href.split('?')[0] + '?_nocache=' + timestamp);
                            });
                        } else {
                            // å¦‚æœä¸æ”¯æ´ Cache APIï¼Œç›´æ¥é‡æ–°è¼‰å…¥
                            window.location.replace(window.location.href.split('?')[0] + '?_nocache=' + timestamp);
                        }
                    } else {
                        // å¦‚æœä¸éœ€è¦æ›´æ–°ï¼Œæ¸…é™¤æ¨™è¨˜
                        sessionStorage.removeItem(processedKey);
                        console.log('æ‰€æœ‰ JavaScript æ–‡ä»¶ç‰ˆæœ¬è™Ÿå·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€é‡æ–°è¼‰å…¥');
                    }
                }
                
                // ç­‰å¾… DOM è¼‰å…¥å®Œæˆå¾Œå†æ›´æ–°
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', updateScriptVersions);
                } else {
                    // DOM å·²ç¶“è¼‰å…¥ï¼Œä½† script æ¨™ç±¤å¯èƒ½é‚„æ²’å®Œå…¨è§£æï¼Œç¨ç­‰ä¸€ä¸‹
                    setTimeout(updateScriptVersions, 50);
                }
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œåˆ— -->
        <header class="header">
            <h1>å°ˆæ¡ˆè¡Œäº‹æ›†</h1>
            <div class="header-controls">
                <button id="prevMonth" class="btn btn-secondary">â—€ ä¸Šå€‹æœˆ</button>
                <span id="currentMonth" class="month-display">2024å¹´1æœˆ</span>
                <button id="nextMonth" class="btn btn-secondary">ä¸‹å€‹æœˆ â–¶</button>
                <button id="reloadExcel" class="btn btn-reload" title="é‡æ–°è®€å– Excel æª”æ¡ˆ">ğŸ“„ é‡æ–°è®€å–</button>
                <button id="clearCache" class="btn btn-cache" title="æ¸…é™¤å¿«å–ä¸¦é‡æ–°è¼‰å…¥">ğŸ”„ æ¸…é™¤å¿«å–</button>
                <button id="settingsBtn" class="btn btn-settings" title="é¡¯ç¤ºè¨­å®š">âš™ï¸ é¡¯ç¤ºè¨­å®š</button>
            </div>
        </header>

        <!-- é¡¯ç¤ºè¨­å®šé¢æ¿ -->
        <div id="settingsPanel" class="settings-panel">
            <div class="settings-content">
                <div class="settings-header">
                    <h3>é¡¯ç¤ºè¨­å®š</h3>
                    <button id="closeSettings" class="close-settings">&times;</button>
                </div>
                <div class="settings-body">
                    <div class="settings-section">
                        <h4 class="settings-section-title">ä»»å‹™æ¢é¡¯ç¤ºè¨­å®š</h4>
                        <p class="settings-description">é¸æ“‡è¦åœ¨æ—¥æ›†ä»»å‹™æ¢ä¸Šé¡¯ç¤ºçš„æ¬„ä½ï¼š</p>
                        <div id="taskBarFieldsOptions" class="settings-options">
                            <!-- å‹•æ…‹ç”Ÿæˆçš„é¸é …å°‡åœ¨é€™è£¡ -->
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button id="applySettings" class="btn btn-primary">å¥—ç”¨</button>
                        <button id="resetSettings" class="btn btn-secondary">é‡ç½®ç‚ºé è¨­</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç’°å¢ƒç¯©é¸å™¨ -->
        <div class="filter-section">
            <h3>ç’°å¢ƒç¯©é¸</h3>
            <div id="environmentFilters" class="filter-buttons">
                <button class="filter-btn active" data-env="all">å…¨éƒ¨é¡¯ç¤º</button>
            </div>
        </div>

        <!-- æœˆæ›†ä¸»é«” -->
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <div class="day-header">æ—¥</div>
                <div class="day-header">ä¸€</div>
                <div class="day-header">äºŒ</div>
                <div class="day-header">ä¸‰</div>
                <div class="day-header">å››</div>
                <div class="day-header">äº”</div>
                <div class="day-header">å…­</div>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <!-- éå·¥ä½œæ—¥èªªæ˜ -->
        <div class="non-working-days-section">
            <h3 class="non-working-days-title">
                <span class="non-working-days-icon">ğŸ“…</span>
                éå·¥ä½œæ—¥èªªæ˜
            </h3>
            <div id="nonWorkingDaysInfo" class="non-working-days-items"></div>
        </div>

        <!-- åœ–ä¾‹ -->
        <div class="legend-section">
            <h3 class="legend-title">
                <span class="legend-icon">ğŸ“‹</span>
                åœ–ä¾‹èªªæ˜
            </h3>
            <div id="legend" class="legend-items"></div>
        </div>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <!-- ä»»å‹™è©³æƒ…å½ˆçª— -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">ä»»å‹™è©³æƒ…</h2>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- å¼•å…¥å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- å¼•å…¥é…ç½®æª”æ¡ˆï¼ˆå¿…é ˆæœ€å…ˆè¼‰å…¥ï¼‰ -->
    <script src="js/config.js?v=2"></script>
    <!-- å¼•å…¥è‡ªè¨‚æ¨¡çµ„ -->
    <script src="js/excel-reader.js?v=30"></script>
    <script src="js/data-processor.js?v=30"></script>
    <script src="js/calendar.js?v=30"></script>
    <script src="js/settings-panel.js?v=1"></script>
    <script src="js/main.js?v=30"></script>
</body>
</html>

